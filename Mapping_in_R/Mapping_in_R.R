#########################
###   Mapping in R    ###
###  Richard Johansen ###
###  April 18th 2019  ###
#########################

#Code: https://github.com/RAJohansen/UCL_Workshops/tree/master/Mapping_in_R
#Data Source: www.gapminder.org/data/


### Introduction to R and Gapminder Data --------------------------------------
#Install & Load Packages
#install.packages("gapminder")
library(dplyr)
library(gapminder)
library(tidyverse)

## Create R Object (data frame) from gapminder
df <- gapminder

###Explore data frame
View(df)
# How many variables
# How many observations
# What type of data is this?
# Do you have expectations at this point?

#country factor with 142 levels
#continent factor with 5 levels
#year ranges from 1952 to 2007 in increments of 5 years
#lifeExp life expectancy at birth, in years
#pop population
#gdpPercap GDP per capita (US$, inflation-adjusted)

## Lets look at the data structure of this data set
str(df)
head(df)
tail(df)
# What are the different data types?
# Why does this matter?
# What is a factor?

##Explore Factor Variables
table(df$country)
table(df$continent)

## Explore Numerical Variables
summary(df)


### Visualizing Gapminder
plot(lifeExp ~ year, gapminder, subset = country == "Afghanistan", type = "b")
plot(lifeExp ~ year, gapminder, subset = country == "United States", type = "b")

#Ploting LifeExp vs. GDP
plot(lifeExp ~ gdpPercap, gapminder, subset = year == 2007)
#What if we change the X-axis scale to log?
plot(lifeExp ~ gdpPercap, gapminder, subset = year == 2007, log = "x")

#***CAUTION: How you choose to visualize information can lead readers to different answers

## Example of grouping data
boxplot(df$lifeExp ~ df$continent)
boxplot(df$gdpPercap ~ df$continent, log = "y")

# Combine two plots into one window
par(mfrow=c(1,2))
boxplot(df$lifeExp ~ df$continent)
boxplot(df$gdpPercap ~ df$continent, log = "y")
#Clear plots
dev.off() 


### Mapping with base plot --------------------------------------------------------
#Install & Load Packages
library(raster)
library(maps)
library(maptools)
library(ggmap)
library(rgdal)

#load a simple basemap
data("wrld_simpl")
data
# Plot World Basemap
plot(wrld_simpl)

#Define Area of Interest
plot(wrld_simpl,
     xlim=c(-130,-60),
     ylim=c(25,50))

#Add colors to map
plot(wrld_simpl,
     xlim=c(-130,-60),
     ylim=c(25,50),
     col='olivedrab3', #Countries
     bg='lightblue') #***Background in this case thats the ocean

# Adding points from Lat Long
coords <- matrix(c(-84.518986, 39.132979),ncol=2)
coords <- coordinates(coords)
spoints <- SpatialPoints(coords)
df <- data.frame(location=c("UC"))
spointsdf <- SpatialPointsDataFrame(spoints,df)
plot(spointsdf,add=T,col=c('red'),pch=16) # add = T; adds this to existing plot

# Lets add the USA
# This pulls data from the internet
USA <- getData('GADM', country="USA", level=1)
plot(USA)

#Remove Alaska and Hawaii
USA_Cont <- subset(USA, NAME_1 != "Alaska" & NAME_1 != "Hawaii")

#Plot Continential USA and Add UC
plot(USA_Cont)
plot(spointsdf,add=T,col=c('red'),pch=16) # add = T; adds this to existing plot
text(-84.518986, 39.132979,labels="University of \n Cincinnati",pos=4, offset=0.3) # add label to an individual plot

### Mapping using Tmap -----------------------------
#https://geocompr.robinlovelace.net/ 
library(raster)
library(sf)
library(spData)        # load geographic data
library(spDataLarge)   # load larger geographic data
library(tmap)
#Lets create an object for Countries
world <- world

#Explore at the variables
names(world)

#Plot the variables for world
plot(world)

#Plot just population
plot(world["pop"]) 

# Plot world using tm functions
tm_shape(world) +
  tm_fill()

# Add boarders to countries
tm_shape(world) +
  tm_fill() + 
  tm_borders() 

# Add population density by countries
tm_shape(world) +
  tm_fill(col = "pop") + 
  tm_borders() 
  

### Interactive Mapping with Leaflet -------------------------------------------

### Raster Data ----------------------------------------------------------------
raster_filepath = system.file("raster/srtm.tif", package = "spDataLarge")
srtm_raster = raster(raster_filepath)
plot(srtm_raster)

### Bathymetric Mapping from NOAA ----------------------------------------------
library(marmap)
library(lattice)
blues <- colorRampPalette(c("darkblue", "cyan"))
greys <- colorRampPalette(c(grey(0.4),grey(0.99)))
Gulf<- getNOAA.bathy(-100,-79,33,23,resolution=10)

plot.bathy(Gulf,
           image = TRUE,
           land = TRUE,
           n=0,
           bpal = list(c(0, max(Gulf), greys(100)),
                       c(min(Gulf), 0, blues(100))))

wireframe(unclass(Gulf), drape = TRUE,
          aspect = c(1, 0.1),
          scales = list(draw=F,arrows=F),
          xlab="",ylab="",zlab="",
          at=c(min(Gulf)/100*(99:0),max(Gulf)/100*(1:99)),
          col.regions = c(blues(100),greys(100)),
          col='transparent')

wireframe(unclass(Gulf), shade = TRUE,
          aspect = c(1, 0.1),
          scales = list(draw=F,arrows=F),
          xlab="",ylab="",zlab="")
